apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: fedpod-jobs-
spec:
  entrypoint: parallel-steps
  arguments:
    parameters:
    - name: rounds
      value: "12"
    - name: initial-round
      value: "00"
    - name: job-prefix
      value: "fed2"
    - name: split_csv
      value: "cc359ppmi128/CC359PPMI_v1.csv"
  templates:
  - name: parallel-steps
    steps:
  # round 0
    - - name: run-train-jobs-00
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{workflow.parameters.initial-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "None"
        withItems:
        - { round: "00", epochs: "002", epoch: "000", inst: "1" }
        - { round: "00", epochs: "002", epoch: "000", inst: "2" }
        - { round: "00", epochs: "002", epoch: "000", inst: "3" }
        - { round: "00", epochs: "002", epoch: "000", inst: "4" }
        - { round: "00", epochs: "002", epoch: "000", inst: "5" }
        - { round: "00", epochs: "002", epoch: "000", inst: "6" }
    - - name: run-aggregation-jobs-00
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{workflow.parameters.initial-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 1
    - - name: run-train-jobs-01
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-00.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-00.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-00.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "01", epochs: "002", epoch: "002", inst: "1" }
        - { round: "01", epochs: "002", epoch: "002", inst: "2" }
        - { round: "01", epochs: "002", epoch: "002", inst: "3" }
        - { round: "01", epochs: "002", epoch: "002", inst: "4" }
        - { round: "01", epochs: "002", epoch: "002", inst: "5" }
        - { round: "01", epochs: "002", epoch: "002", inst: "6" }
    - - name: run-aggregation-jobs-01
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-00.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 2
    - - name: run-train-jobs-02
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-01.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-01.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-01.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "02", epochs: "002", epoch: "004", inst: "1" }
        - { round: "02", epochs: "002", epoch: "004", inst: "2" }
        - { round: "02", epochs: "002", epoch: "004", inst: "3" }
        - { round: "02", epochs: "002", epoch: "004", inst: "4" }
        - { round: "02", epochs: "002", epoch: "004", inst: "5" }
        - { round: "02", epochs: "002", epoch: "004", inst: "6" }
    - - name: run-aggregation-jobs-02
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-01.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 3
    - - name: run-train-jobs-03
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-02.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-02.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-02.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "03", epochs: "002", epoch: "006", inst: "1" }
        - { round: "03", epochs: "002", epoch: "006", inst: "2" }
        - { round: "03", epochs: "002", epoch: "006", inst: "3" }
        - { round: "03", epochs: "002", epoch: "006", inst: "4" }
        - { round: "03", epochs: "002", epoch: "006", inst: "5" }
        - { round: "03", epochs: "002", epoch: "006", inst: "6" }
    - - name: run-aggregation-jobs-03
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-02.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 4
    - - name: run-train-jobs-04
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-03.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-03.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-03.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "04", epochs: "002", epoch: "008", inst: "1" }
        - { round: "04", epochs: "002", epoch: "008", inst: "2" }
        - { round: "04", epochs: "002", epoch: "008", inst: "3" }
        - { round: "04", epochs: "002", epoch: "008", inst: "4" }
        - { round: "04", epochs: "002", epoch: "008", inst: "5" }
        - { round: "04", epochs: "002", epoch: "008", inst: "6" }
    - - name: run-aggregation-jobs-04
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-03.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 5
    - - name: run-train-jobs-05
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-04.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-04.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-04.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "05", epochs: "002", epoch: "010", inst: "1" }
        - { round: "05", epochs: "002", epoch: "010", inst: "2" }
        - { round: "05", epochs: "002", epoch: "010", inst: "3" }
        - { round: "05", epochs: "002", epoch: "010", inst: "4" }
        - { round: "05", epochs: "002", epoch: "010", inst: "5" }
        - { round: "05", epochs: "002", epoch: "010", inst: "6" }
    - - name: run-aggregation-jobs-05
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-04.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 6
    - - name: run-train-jobs-06
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-05.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-05.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-05.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "06", epochs: "002", epoch: "012", inst: "1" }
        - { round: "06", epochs: "002", epoch: "012", inst: "2" }
        - { round: "06", epochs: "002", epoch: "012", inst: "3" }
        - { round: "06", epochs: "002", epoch: "012", inst: "4" }
        - { round: "06", epochs: "002", epoch: "012", inst: "5" }
        - { round: "06", epochs: "002", epoch: "012", inst: "6" }
    - - name: run-aggregation-jobs-06
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-05.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 7
    - - name: run-train-jobs-07
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-06.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-06.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-06.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "07", epochs: "002", epoch: "014", inst: "1" }
        - { round: "07", epochs: "002", epoch: "014", inst: "2" }
        - { round: "07", epochs: "002", epoch: "014", inst: "3" }
        - { round: "07", epochs: "002", epoch: "014", inst: "4" }
        - { round: "07", epochs: "002", epoch: "014", inst: "5" }
        - { round: "07", epochs: "002", epoch: "014", inst: "6" }
    - - name: run-aggregation-jobs-07
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-06.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 8
    - - name: run-train-jobs-08
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-07.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-07.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-07.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "08", epochs: "002", epoch: "016", inst: "1" }
        - { round: "08", epochs: "002", epoch: "016", inst: "2" }
        - { round: "08", epochs: "002", epoch: "016", inst: "3" }
        - { round: "08", epochs: "002", epoch: "016", inst: "4" }
        - { round: "08", epochs: "002", epoch: "016", inst: "5" }
        - { round: "08", epochs: "002", epoch: "016", inst: "6" }
    - - name: run-aggregation-jobs-08
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-07.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 9
    - - name: run-train-jobs-09
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-08.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-08.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-08.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "09", epochs: "002", epoch: "018", inst: "1" }
        - { round: "09", epochs: "002", epoch: "018", inst: "2" }
        - { round: "09", epochs: "002", epoch: "018", inst: "3" }
        - { round: "09", epochs: "002", epoch: "018", inst: "4" }
        - { round: "09", epochs: "002", epoch: "018", inst: "5" }
        - { round: "09", epochs: "002", epoch: "018", inst: "6" }
    - - name: run-aggregation-jobs-09
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-08.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 10
    - - name: run-train-jobs-10
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-09.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-09.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-09.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "10", epochs: "001", epoch: "020", inst: "1" }
        - { round: "10", epochs: "001", epoch: "020", inst: "2" }
        - { round: "10", epochs: "001", epoch: "020", inst: "3" }
        - { round: "10", epochs: "001", epoch: "020", inst: "4" }
        - { round: "10", epochs: "001", epoch: "020", inst: "5" }
        - { round: "10", epochs: "001", epoch: "020", inst: "6" }
    - - name: run-aggregation-jobs-10
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-09.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"
  # round 11
    - - name: run-train-jobs-11
        template: train-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-10.outputs.parameters.next-round}}"
          - name: epochs
            value: "{{item.epochs}}"
          - name: epoch
            value: "{{item.epoch}}"
          - name: inst-id
            value: "{{item.inst}}"
          - name: model_pth
            value: "/fedpod/states/{{workflow.parameters.job-prefix}}_0/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-10.outputs.parameters.next-round}}/models/R{{workflow.parameters.rounds}}r{{steps.run-aggregation-jobs-10.outputs.parameters.next-round}}.pth"
        withItems:
        - { round: "11", epochs: "001", epoch: "021", inst: "1" }
        - { round: "11", epochs: "001", epoch: "021", inst: "2" }
        - { round: "11", epochs: "001", epoch: "021", inst: "3" }
        - { round: "11", epochs: "001", epoch: "021", inst: "4" }
        - { round: "11", epochs: "001", epoch: "021", inst: "5" }
        - { round: "11", epochs: "001", epoch: "021", inst: "6" }
    - - name: run-aggregation-jobs-11
        template: aggregation-job
        arguments:
          parameters:
          - name: round
            value: "{{steps.run-aggregation-jobs-10.outputs.parameters.next-round}}"
          - name: algorithm
            value: "fedavg"
          - name: inst-id
            value: "0"
          - name: model_pth
            value: "None"




  - name: train-job
    inputs:
      parameters:
      - name: round
      - name: epochs
      - name: epoch
      - name: inst-id
      - name: model_pth
    container:
      image: dwnusa/fedpod:v0.4.14.16
      command: ["/bin/sh", "-c"]
      args: ["./run_train2.sh -s 1 -g 0 -J {{workflow.parameters.job-prefix}}_{{inputs.parameters.inst-id}} -R {{workflow.parameters.rounds}} -r {{inputs.parameters.round}} -E {{inputs.parameters.epochs}} -e {{inputs.parameters.epoch}} -i {{inputs.parameters.inst-id}} -c {{workflow.parameters.split_csv}} -m {{inputs.parameters.model_pth}}"]
      resources:
        requests:
          cpu: "2"
          memory: "16G"
        # limits:
        #   cpu: "4"
        #   memory: "86G"
      volumeMounts:
      - name: cc359ppmi128-volume
        mountPath: /fedpod/cc359ppmi128
      - name: states-volume
        mountPath: /fedpod/states
      - name: logs-volume
        mountPath: /fedpod/logs
      stdin: true
      tty: true
    volumes:
    - name: cc359ppmi128-volume
      hostPath:
        path: /fedpod/cc359ppmi128  # 로컬 경로
        type: Directory
    - name: states-volume
      hostPath:
        path: /fedpod/states  # 로컬 경로
        type: Directory
    - name: logs-volume
      hostPath:
        path: /fedpod/logs  # 로컬 경로
        type: Directory


  - name: aggregation-job
    inputs:
      parameters:
      - name: round
      - name: algorithm
      - name: inst-id
      - name: model_pth
    container:
      image: dwnusa/fedpod:v0.4.14.16
      command: ["/bin/sh", "-c"]
      args: ["./run_aggregation.sh -R {{workflow.parameters.rounds}} -r {{inputs.parameters.round}} -a {{inputs.parameters.algorithm}} -j {{workflow.parameters.job-prefix}} -i {{inputs.parameters.inst-id}} -m {{inputs.parameters.model_pth}}"]
      # args: ["./run_aggregation.sh -r 0 -R 5 -a fedavg -j inst -i 0 -m /fedpod/cc359ppmi128/R00E000.pth"]
      resources:
        requests:
          cpu: "2"
          memory: "4G"
      volumeMounts:
      - name: cc359ppmi128-volume
        mountPath: /fedpod/cc359ppmi128
      - name: states-volume
        mountPath: /fedpod/states
      - name: logs-volume
        mountPath: /fedpod/logs
      stdin: true
      tty: true
    volumes:
    - name: cc359ppmi128-volume
      hostPath:
        path: /fedpod/cc359ppmi128  # 로컬 경로
        type: Directory
    - name: states-volume
      hostPath:
        path: /fedpod/states  # 로컬 경로
        type: Directory
    - name: logs-volume
      hostPath:
        path: /fedpod/logs  # 로컬 경로
        type: Directory
