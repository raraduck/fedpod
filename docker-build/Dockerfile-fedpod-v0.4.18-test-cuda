# 1. Base Image: 호스트 드라이버(550.x)와 호환되는 CUDA 12.4.1 사용
FROM nvidia/cuda:12.4.1-base-ubuntu22.04

# 2. 환경설정: RTX 4090 호환성(Error 804) 해결을 위한 필수 설정
ENV LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/usr/local/cuda/lib64
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# 3. 필수 패키지 설치
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    git \
    && rm -rf /var/lib/apt/lists/*

# 4. [중요] 호환성 충돌을 일으키는 폴더 삭제 (RTX 4090용)
RUN rm -rf /usr/local/cuda/compat

# 5. Pip 업그레이드
RUN python3 -m pip install --upgrade pip

# 6. [핵심] PyTorch 2.5.1 (GPU 버전) 설치
# --index-url을 지정하지 않으면 CPU 버전이 깔릴 수 있습니다!
# cu124는 CUDA 12.4용 빌드를 의미합니다.
RUN pip3 install --no-cache-dir \
    torch==2.5.1 \
    torchvision==0.20.1 \
    torchaudio==2.5.1 \
    --index-url https://download.pytorch.org/whl/cu124

# 7. 나머지 Python 라이브러리 설치
# (PyTorch는 위에서 이미 설치했으므로 리스트에서 뺐습니다)
RUN pip3 install --no-cache-dir \
    SimpleITK==2.2.1 \
    medpy \
    matplotlib \
    natsort \
    nibabel \
    numpy \
    pandas \
    pillow \
    tensorboard \
    monai

WORKDIR /fedpod

CMD ["python3", "--version"]